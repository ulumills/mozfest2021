/**
 * sparse-octree v6.1.0 build Tue Aug 18 2020
 * https://github.com/vanruesc/sparse-octree
 * Copyright 2020 Raoul van RÃ¼schen
 * @license Zlib
 */
!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("math-ds")):"function"==typeof define&&define.amd?define(["exports","math-ds"],n):n((t="undefined"!=typeof globalThis?globalThis:t||self).SPARSEOCTREE={},t.MATHDS)}(this,(function(t,n){"use strict";var e=[new Uint8Array([0,4]),new Uint8Array([1,5]),new Uint8Array([2,6]),new Uint8Array([3,7]),new Uint8Array([0,2]),new Uint8Array([1,3]),new Uint8Array([4,6]),new Uint8Array([5,7]),new Uint8Array([0,1]),new Uint8Array([2,3]),new Uint8Array([4,5]),new Uint8Array([6,7])],i=[new Uint8Array([0,0,0]),new Uint8Array([0,0,1]),new Uint8Array([0,1,0]),new Uint8Array([0,1,1]),new Uint8Array([1,0,0]),new Uint8Array([1,0,1]),new Uint8Array([1,1,0]),new Uint8Array([1,1,1])],r=new n.Vector3,o=function(t,e){void 0===t&&(t=new n.Vector3),void 0===e&&(e=0),this.min=t,this.size=e,this.children=null},s={max:{configurable:!0}};s.max.get=function(){return this.min.clone().addScalar(this.size)},o.prototype.getCenter=function(t){return t.copy(this.min).addScalar(.5*this.size)},o.prototype.getDimensions=function(t){return t.set(this.size,this.size,this.size)},o.prototype.split=function(){var t,e,o=this.min,s=this.getCenter(r),a=.5*this.size,l=this.children=[null,null,null,null,null,null,null,null];for(t=0;t<8;++t)e=i[t],l[t]=new this.constructor(new n.Vector3(0===e[0]?o.x:s.x,0===e[1]?o.y:s.y,0===e[2]?o.z:s.z),a)},Object.defineProperties(o.prototype,s);var a=new n.Vector3,l=function(t,e){void 0===t&&(t=new n.Vector3),void 0===e&&(e=new n.Vector3),this.min=t,this.max=e,this.children=null};l.prototype.getCenter=function(t){return t.addVectors(this.min,this.max).multiplyScalar(.5)},l.prototype.getDimensions=function(t){return t.subVectors(this.max,this.min)},l.prototype.split=function(){var t,e,r=this.min,o=this.max,s=this.getCenter(a),l=this.children=[null,null,null,null,null,null,null,null];for(t=0;t<8;++t)e=i[t],l[t]=new this.constructor(new n.Vector3(0===e[0]?r.x:s.x,0===e[1]?r.y:s.y,0===e[2]?r.z:s.z),new n.Vector3(0===e[0]?s.x:o.x,0===e[1]?s.y:o.y,0===e[2]?s.z:o.z))};var u=function(t,n,e,i){void 0===i&&(i=null),this.distance=t,this.distanceToRay=n,this.point=e,this.object=i};function c(t,e,i){var r,o,s,a,l,c,h,p,f,d,y,v=e.params.Points.threshold,m=v*v;for(l=0,h=t.length;l<h;++l)if(null!==(d=(f=t[l]).points))for(c=0,p=d.length;c<p;++c)y=d[c],(a=e.ray.distanceSqToPoint(y))<m&&(r=e.ray.closestPointToPoint(y,new n.Vector3),(o=e.ray.origin.distanceTo(r))>=e.near&&o<=e.far&&(s=Math.sqrt(a),i.push(new u(o,s,r,f.data[c]))))}var h=function(){this.value=0};function p(t,n,e,i,r,o){var s=0;return t>n&&t>e?(r<t&&(s|=2),o<t&&(s|=1)):n>e?(i<n&&(s|=4),o<n&&(s|=1)):(i<e&&(s|=4),r<e&&(s|=2)),s}var f=[new Uint8Array([4,2,1]),new Uint8Array([5,3,8]),new Uint8Array([6,8,3]),new Uint8Array([7,8,8]),new Uint8Array([8,6,5]),new Uint8Array([8,7,8]),new Uint8Array([8,8,7]),new Uint8Array([8,8,8])];function d(t,n,e,i){var r,o=0;return n<e?(r=n,o=0):(r=e,o=1),i<r&&(o=2),f[t][o]}var y=new n.Vector3,v=new n.Box3,m=new n.Box3,x=new n.Ray;function g(t,n,e){var i,r,o,s,a,l,u,c,h,p=v.min.set(0,0,0),f=v.max.subVectors(t.max,t.min),d=t.getDimensions(m.min),g=m.max.copy(d).multiplyScalar(.5),w=x.origin.copy(n.origin),b=x.direction.copy(n.direction);return w.sub(t.getCenter(y)).add(g),e.value=0,b.x<0&&(w.x=d.x-w.x,b.x=-b.x,e.value|=4),b.y<0&&(w.y=d.y-w.y,b.y=-b.y,e.value|=2),b.z<0&&(w.z=d.z-w.z,b.z=-b.z,e.value|=1),i=1/b.x,r=1/b.y,o=1/b.z,s=(p.x-w.x)*i,a=(f.x-w.x)*i,l=(p.y-w.y)*r,u=(f.y-w.y)*r,c=(p.z-w.z)*o,h=(f.z-w.z)*o,Math.max(Math.max(s,l),c)<Math.min(Math.min(a,u),h)?[s,l,c,a,u,h]:null}var w=new h;function b(t,n,e,i,r,o,s,a){if(r>=0&&o>=0&&s>=0){var l=t.children;if(null===l)a.push(t);else{var u=.5*(n+r),c=.5*(e+o),h=.5*(i+s),f=w.value,y=p(n,e,i,u,c,h);do{switch(y){case 0:b(l[f],n,e,i,u,c,h,a),y=d(y,u,c,h);break;case 1:b(l[1^f],n,e,h,u,c,s,a),y=d(y,u,c,s);break;case 2:b(l[2^f],n,c,i,u,o,h,a),y=d(y,u,o,h);break;case 3:b(l[3^f],n,c,h,u,o,s,a),y=d(y,u,o,s);break;case 4:b(l[4^f],u,e,i,r,c,h,a),y=d(y,r,c,h);break;case 5:b(l[5^f],u,e,h,r,c,s,a),y=d(y,r,c,s);break;case 6:b(l[6^f],u,c,i,r,o,h,a),y=d(y,r,o,h);break;case 7:b(l[7^f],u,c,h,r,o,s,a),y=8}}while(y<8)}}}var z=function(){};z.intersectOctree=function(t,n,e){void 0===e&&(e=[]);var i=g(t,n,w);null!==i&&b.apply(void 0,[t.root].concat(i,[e]))};var A=function(t,n){void 0===t&&(t=null),void 0===n&&(n=!1),this.value=t,this.done=n};A.prototype.reset=function(){this.value=null,this.done=!1};var U=new n.Box3,O=function(t,n){void 0===n&&(n=null),this.octree=t,this.region=n,this.cull=null!==n,this.result=new A,this.trace=null,this.indices=null,this.reset()};O.prototype.reset=function(){var t=this.octree.root;return this.trace=[],this.indices=[],null!==t&&(U.min=t.min,U.max=t.max,this.cull&&!this.region.intersectsBox(U)||(this.trace.push(t),this.indices.push(0))),this.result.reset(),this},O.prototype.next=function(){for(var t,n,e,i=this.cull,r=this.region,o=this.indices,s=this.trace,a=null,l=s.length-1;null===a&&l>=0;)if(t=o[l]++,n=s[l].children,t<8)if(null!==n){if(e=n[t],i&&(U.min=e.min,U.max=e.max,!r.intersectsBox(U)))continue;s.push(e),o.push(0),++l}else a=s.pop(),o.pop();else s.pop(),o.pop(),--l;return this.result.value=a,this.result.done=null===a,this.result},O.prototype.return=function(t){return this.result.value=t,this.result.done=!0,this.result},O.prototype[Symbol.iterator]=function(){return this};var P=new n.Box3;var C=function(t){this.root=t},S={min:{configurable:!0},max:{configurable:!0},children:{configurable:!0}};S.min.get=function(){return this.root.min},S.max.get=function(){return this.root.max},S.children.get=function(){return this.root.children},C.prototype.getCenter=function(t){return this.root.getCenter(t)},C.prototype.getDimensions=function(t){return this.root.getDimensions(t)},C.prototype.cull=function(t){var n=[];return function t(n,e,i){var r,o,s=n.children;if(P.min=n.min,P.max=n.max,e.intersectsBox(P))if(null!==s)for(r=0,o=s.length;r<o;++r)t(s[r],e,i);else i.push(n)}(this.root,t,n),n},C.prototype.getDepth=function(){return function t(n){var e,i,r,o=n.children,s=0;if(null!==o)for(e=0,i=o.length;e<i;++e)(r=1+t(o[e]))>s&&(s=r);return s}(this.root)},C.prototype.findNodesByLevel=function(t){var n=[];return function t(n,e,i,r){var o,s,a=n.children;if(i===e)r.push(n);else if(null!==a)for(++i,o=0,s=a.length;o<s;++o)t(a[o],e,i,r)}(this.root,t,0,n),n},C.prototype.raycast=function(t,n){return void 0===n&&(n=[]),z.intersectOctree(this,t.ray,n),n},C.prototype.leaves=function(t){return new O(this,t)},C.prototype[Symbol.iterator]=function(){return new O(this)},Object.defineProperties(C.prototype,S);var q=new n.Vector3,V=function(t){function n(n,e){t.call(this,n,e),this.points=null,this.data=null}return t&&(n.__proto__=t),n.prototype=Object.create(t&&t.prototype),n.prototype.constructor=n,n.prototype.distanceToSquared=function(t){return q.copy(t).clamp(this.min,this.max).sub(t).lengthSquared()},n.prototype.distanceToCenterSquared=function(t){var n=this.getCenter(q),e=t.x-n.x,i=t.y-n.x,r=t.z-n.z;return e*e+i*i+r*r},n.prototype.contains=function(t,n){var e=this.min,i=this.max;return t.x>=e.x-n&&t.y>=e.y-n&&t.z>=e.z-n&&t.x<=i.x+n&&t.y<=i.y+n&&t.z<=i.z+n},n.prototype.redistribute=function(t){var n,e,i,r,o,s,a,l=this.children,u=this.points,c=this.data;if(null!==l&&null!==u){for(n=0,i=u.length;n<i;++n)for(s=u[n],a=c[n],e=0,r=l.length;e<r;++e)if((o=l[e]).contains(s,t)){null===o.points&&(o.points=[],o.data=[]),o.points.push(s),o.data.push(a);break}this.points=null,this.data=null}},n.prototype.merge=function(){var t=this.children;if(null!==t){var n,e,i,r=[],o=[];for(n=0,e=t.length;n<e;++n)null!==(i=t[n]).points&&(r=r.concat(i.points),o=o.concat(i.data));this.children=null,this.points=r,this.data=o}},n}(l);function T(t){var n,e,i=t.children,r=0;if(null!==i)for(n=0,e=i.length;n<e;++n)r+=T(i[n]);else null!==t.points&&(r=t.points.length);return r}function M(t,n,e,i,r){var o,s,a=i.children,l=!1,u=!1;if(i.contains(t,e.bias)){if(null===a){if(null===i.points)i.points=[],i.data=[];else for(o=0,s=i.points.length;!l&&o<s;++o)l=i.points[o].equals(t);l?(i.data[o-1]=n,u=!0):i.points.length<e.maxPoints||r===e.maxDepth?(i.points.push(t.clone()),i.data.push(n),++e.pointCount,u=!0):(i.split(),i.redistribute(e.bias),a=i.children)}if(null!==a)for(++r,o=0,s=a.length;!u&&o<s;++o)u=M(t,n,e,a[o],r)}return u}function k(t,n,e,i){var r,o,s,a,l,u=e.children,c=null;if(e.contains(t,n.bias))if(null!==u)for(r=0,o=u.length;null===c&&r<o;++r)c=k(t,n,u[r],e);else if(null!==e.points)for(s=e.points,a=e.data,r=0,o=s.length;r<o;++r)if(s[r].equals(t)){l=o-1,c=a[r],r<l&&(s[r]=s[l],a[r]=a[l]),s.pop(),a.pop(),--n.pointCount,null!==i&&T(i)<=n.maxPoints&&i.merge();break}return c}var _=function(t){function n(n,e,i,r,o){void 0===i&&(i=0),void 0===r&&(r=8),void 0===o&&(o=8),t.call(this,new V(n,e)),this.bias=Math.max(0,i),this.maxPoints=Math.max(1,Math.round(r)),this.maxDepth=Math.max(0,Math.round(o)),this.pointCount=0}return t&&(n.__proto__=t),n.prototype=Object.create(t&&t.prototype),n.prototype.constructor=n,n.prototype.countPoints=function(t){return T(t)},n.prototype.insert=function(t,n){return M(t,n,this,this.root,0)},n.prototype.remove=function(t){return k(t,this,this.root,null)},n.prototype.get=function(t){return function t(n,e,i){var r,o,s,a=i.children,l=null;if(i.contains(n,e.bias))if(null!==a)for(r=0,o=a.length;null===l&&r<o;++r)l=t(n,e,a[r]);else if(null!==i.points)for(r=0,o=(s=i.points).length;null===l&&r<o;++r)n.equals(s[r])&&(l=i.data[r]);return l}(t,this,this.root)},n.prototype.move=function(t,n){return function t(n,e,i,r,o,s){var a,l,u,c=r.children,h=null;if(r.contains(n,i.bias))if(r.contains(e,i.bias)){if(null!==c)for(++s,a=0,l=c.length;null===h&&a<l;++a)h=t(n,e,i,c[a],r,s);else if(null!==r.points)for(a=0,l=(u=r.points).length;a<l;++a)if(n.equals(u[a])){u[a].copy(e),h=r.data[a];break}}else M(e,h=k(n,i,r,o),i,o,s-1);return h}(t,n,this,this.root,null,0)},n.prototype.findNearestPoint=function(t,n,e){void 0===n&&(n=1/0),void 0===e&&(e=!1);var i=function t(n,e,i,r){var o,s,a=null,l=e;if(null!==r.children){var u,c,h=r.children.map((function(t){return{octant:t,distance:t.distanceToCenterSquared(n)}})).sort((function(t,n){return t.distance-n.distance}));for(o=0,s=h.length;o<s&&(!(u=h[o].octant).contains(n,l)||null===(c=t(n,l,i,u))||(a=c,0!==(l=c.distance)));++o);}else if(null!==r.points){var p,f=r.points,d=-1;for(o=0,s=f.length;o<s;++o)if(f[o].equals(n)){if(!i){l=0,d=o;break}}else(p=n.distanceTo(f[o]))<l&&(l=p,d=o);d>=0&&(a={point:f[d],data:r.data[d],distance:l})}return a}(t,n,e,this.root);return null!==i&&(i.point=i.point.clone()),i},n.prototype.findPoints=function(t,n,e){void 0===e&&(e=!1);var i=[];return function t(n,e,i,r,o){var s,a,l,u=r.children;if(null!==u)for(s=0,a=u.length;s<a;++s)(l=u[s]).contains(n,e)&&t(n,e,i,l,o);else if(null!==r.points){var c,h=r.points,p=e*e;for(s=0,a=h.length;s<a;++s)(c=h[s]).equals(n)?i||o.push({point:c.clone(),data:r.data[s]}):c.distanceToSquared(n)<=p&&o.push({point:c.clone(),data:r.data[s]})}}(t,n,e,this.root,i),i},n.prototype.raycast=function(n,e){void 0===e&&(e=[]);var i=t.prototype.raycast.call(this,n);return i.length>0&&c(i,n,e),e},n}(C);t.CubicOctant=o,t.Flags=h,t.Octant=l,t.Octree=C,t.OctreeIterator=O,t.OctreeRaycaster=z,t.PointOctant=V,t.PointOctree=_,t.RayPointIntersection=u,t.edges=e,t.findEntryOctant=p,t.findNextOctant=d,t.intersectOctree=g,t.layout=i,t.testPoints=c,Object.defineProperty(t,"__esModule",{value:!0})}));
